name: traefik

services:
  app:
    image: traefik:${TRAEFIK_TAG:-latest}
    extends:
      file: ../fragments/services.yml
      service: service-main-hc
    networks:
      - proxy
      - exposed
    healthcheck:
      test: "(ps -o comm | grep -q -m 1 traefik) || exit 1"
    extra_hosts:
      host.docker.internal: ${EXPOSED_BRIDGE_GATEWAY:?No proxy bridge gateway set}
    ports:
      - "80:80"         # http
      - "443:443"       # https
    env_file: stack.env
    volumes:
      - ${DOCKER_SOCKET:-/var/run/docker.sock}:/var/run/docker.sock
      - ${PROJECT_CONF_DIR:-${CONF_DIR:-/etc}/${COMPOSE_PROJECT_NAME}}:/etc/traefik
      - ${PROJECT_LOGS_DIR:-${LOGS_DIR:-/var/log}/${COMPOSE_PROJECT_NAME}}:/log
      - ${LETSENCRYPT_DIR:-/etc/letsencrypt}:/etc/letsencrypt
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.${COMPOSE_PROJECT_NAME}.rule=Host(`${COMPOSE_PROJECT_NAME}.${MACHINE_DOMAIN:?Machine domain is not set}`)"
      - "traefik.http.routers.${COMPOSE_PROJECT_NAME}.service=api@internal"
      - "traefik.http.routers.${COMPOSE_PROJECT_NAME}.entrypoints=http,https"

networks:
  proxy:
    external: true
  exposed:
    external: true
